# 3. 设定索引方法与检索设置

选定内容的分段模式后，接下来要为结构化内容设定**索引方法**与**检索设置**。

## 设定索引方法

如同搜索引擎借助高效索引算法匹配与用户问题最相关的网页内容，合理的索引方式对 LLM 检索知识库内容的效率和回答的准确性起着直接影响。

系统提供“高质量”与“经济”两种索引方法，每种方法都有不同的检索设置选项。

**注意**：原 **Q&A 模式（仅适用于社区版）** 现已成为高质量索引方法下的一个可选项。

### 高质量模式
- **原理**：使用 Embedding 嵌入模型将已分段的文本块转换为数字向量，能更有效地压缩与存储大量文本信息，让用户问题与文本的匹配更加精准。
- **检索设置**：内容块向量化并录入数据库后，需通过有效的检索方式调取匹配内容块。该模式提供向量检索、全文检索和混合检索三种检索设置，具体说明见[检索设置](#retrieval_settings)。
- **模式限制**：选择高质量模式后，当前知识库的索引方式无法降级为“经济”索引模式。如需切换，建议重新创建知识库并重选索引方式。
- **相关参考**：如需了解更多关于嵌入技术与向量的说明，请参考[《Embedding 技术与 Dify》](https://mp.weixin.qq.com/s/vmY_CUmETo2IpEBf1nEGLQ)。
- **图示**：
![高质量模式](https://assets-docs.dify.ai/2024/12/51442c8fcd05479616a3dd8279a4853a.png)

#### 启用 Q&A 模式（可选，仅适用于[社区版](../../../getting-started/install-self-hosted/)）
- **原理**：开启该模式后，系统对已上传文本进行分段，总结内容后为每个分段自动生成 Q&A 匹配对。与常见的「Q to P」（用户问题匹配文本段落）策略不同，采用「Q to Q」（问题匹配问题）策略。
- **优势**：「常见问题」文档里的文本通常是具备完整语法结构的自然语言，Q to Q 模式使问题和答案的匹配更清晰，能满足高频和高相似度问题的提问场景。
- **限制**：Q&A 模式仅支持处理「中英日」三语。启用该模式后可能会消耗更多的 LLM Tokens，并且无法使用[经济型索引方法](setting-indexing-methods.md#jing-ji)。
- **图示**：
![Q&A Chunking](https://assets-docs.dify.ai/2024/12/70960a237d4f5eaed2dbf46a2cca2bf7.png)
![Q to P 与 Q to Q 的索引模式区别](https://assets-docs.dify.ai/2024/12/8745ccabff56290eae329a9d3592f745.png)

### 经济模式
- **原理**：在经济模式下，每个区块内使用 10 个关键词进行检索，降低了准确度但无需产生费用。对于检索到的区块，仅提供倒排索引方式选择最相关的区块，详细说明见[下文](setting-indexing-methods.md#dao-pai-suo-yin)。
- **模式调整**：选择经济型索引方式后，若感觉实际效果不佳，可以在知识库设置页中升级为“高质量”索引方式。
- **图示**：
![经济模式](https://assets-docs.dify.ai/2024/12/3b86e6b484da39452c164cb6372a7242.png)

## 指定检索方式 <a href="#retrieval_settings" id="retrieval_settings"></a>

知识库接收用户查询问题后，会按预设检索方式在已有文档内查找相关内容，提取高度相关的信息片段供语言模型生成高质量答案。这一过程决定了 LLM 所能获取的背景信息，进而影响生成结果的准确性和可信度。

常见的检索方式有基于向量相似度的语义检索和基于关键词的精准匹配：前者将文本内容块和问题查询转化为向量，通过计算向量相似度匹配更深层次的语义关联；后者通过倒排索引，即搜索引擎常用的检索方法，匹配问题与关键内容。

不同的索引方法对应不同的检索设置。

### 高质量索引
在高质量索引方式下，Dify 提供向量检索、全文检索与混合检索设置。
![检索设置](https://assets-docs.dify.ai/2024/12/9b02fc353324221cc91f185a350775b6.png)

#### 向量检索
- **定义**：向量化用户输入的问题并生成查询文本的数学向量，比较查询向量与知识库内对应文本向量间的距离，寻找相邻的分段内容。
- **图示**：
![向量检索](https://assets-docs.dify.ai/2024/12/620044faa47a5037f85b32a27a56fce5.png)
- **设置参数**：
    - **Rerank 模型**：默认关闭。开启后将使用第三方 Rerank 模型对向量检索召回的内容分段再次重排序，优化排序结果，帮助 LLM 获取更精确内容，提升输出质量。开启前，需前往“设置” → “模型供应商”，提前配置 Rerank 模型的 API 秘钥。开启该功能会消耗 Rerank 模型的 Tokens，详情参考对应模型的价格说明。
    - **TopK**：用于筛选与用户问题相似度最高的文本片段。系统会根据选用模型上下文窗口大小动态调整片段数量，默认值为 3。数值越高，预期被召回的文本分段数量越多。
    - **Score 阈值**：用于设置文本片段筛选的相似度阈值，只召回超过设置分数的文本片段，默认值为 0.5。数值越高，对文本与问题的相似度要求越高，预期被召回的文本数量越少。
    - **注意**：TopK 和 Score 设置仅在 Rerank 步骤生效，需添加并开启 Rerank 模型才能应用两者的设置参数。

#### 全文检索
- **定义**：关键词检索，即索引文档中的所有词汇。用户输入问题后，通过明文关键词匹配知识库内对应的文本片段，返回符合关键词的文本片段，类似搜索引擎中的明文检索。
- **图示**：
![全文检索](https://assets-docs.dify.ai/2024/12/513bff1ca38ec746b3246502b0311b39.png)
- **设置参数**：
    - **Rerank 模型**：默认关闭。开启后使用第三方 Rerank 模型对全文检索召回的内容分段再次重排序，优化结果，辅助 LLM 提升输出内容质量。开启前需配置 Rerank 模型的 API 秘钥，开启会消耗 Tokens，参考对应模型价格说明。
    - **TopK**：用于筛选与用户问题相似度最高的文本片段，系统根据模型上下文窗口大小动态调整数量，默认值为 3。数值越高，预期被召回的文本分段数量越多。
    - **Score 阈值**：用于设置文本片段筛选的相似度阈值，默认值为 0.5。数值越高，对文本与问题相似度要求越高，预期被召回的文本数量越少。
    - **注意**：TopK 和 Score 设置仅在 Rerank 步骤生效，需开启 Rerank 模型才能应用。

#### 混合检索
- **定义**：同时执行全文检索和向量检索，或使用 Rerank 模型，从查询结果中选择匹配用户问题的最佳结果。
- **图示**：
![混合检索](https://assets-docs.dify.ai/2024/12/bd2621bfe8a1a8e21fca0743ec495a9e.png)
- **设置选项**：
    - **权重设置**：允许用户为语义优先和关键词优先赋予自定义权重。关键词检索指在知识库内进行全文检索（Full Text Search），语义检索指在知识库内进行向量检索（Vector Search）。
        - **将语义值拉至 1**：仅启用语义检索模式。借助 Embedding 模型，即便知识库中没有查询的确切词汇，也能通过计算向量距离提高搜索深度，返回正确内容。处理多语言内容时，语义检索能捕捉不同语言间的意义转换，提供更准确的跨语言搜索结果。
        - **将关键词的值拉至 1**：仅启用关键词检索模式。通过用户输入的信息文本在知识库全文匹配，适用于用户知道确切信息或术语的场景。该方法计算资源消耗低，适合在大量文档的知识库内快速检索。
        - **自定义关键词和语义权重**：除将数值拉至 1，还可调试二者权重，找到符合业务场景的最佳比例。
    - **Rerank 模型**：默认关闭。开启后使用第三方 Rerank 模型对混合检索召回的内容分段再次重排序，优化结果，辅助 LLM 提升输出内容质量。开启前需配置 Rerank 模型的 API 秘钥，开启会消耗 Tokens，参考对应模型价格说明。

### 经济索引
#### 倒排索引
在经济索引方式下，仅提供倒排索引方式。这是一种用于快速检索文档中关键词的索引结构，常用于在线搜索引擎。倒排索引仅支持 **TopK** 设置项。
- **TopK**：用于筛选与用户问题相似度最高的文本片段。系统会根据选用模型上下文窗口大小动态调整片段数量，默认值为 3。数值越高，预期被召回的文本分段数量越多。
- **图示**：
![倒排索引](https://assets-docs.dify.ai/2024/12/b417cd028131d34779993fbcbb8dbdd7.png)

## 阅读更多
指定检索设置后，你可以参考以下文档查看在实际场景下，关键词与内容块的匹配情况。
{% content-ref url="../retrieval-test-and-citation.md" %}
[retrieval-test-and-citation.md](../retrieval-test-and-citation.md)
{% endcontent-ref %}
